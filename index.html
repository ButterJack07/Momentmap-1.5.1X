<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>MomentMap PRO 0.1.1</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
    html,body{margin:0;height:100%;overflow:hidden;font-family:Arial}
    #map{width:100%;height:100%;z-index:1}
    #loginMask{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10001}
    #loginBox{background:#fff;padding:20px;width:260px;border-radius:6px}
    #loginBox input,#loginBox button{width:100%;padding:8px;margin-top:8px;box-sizing:border-box}
    #chatPanel{position:fixed;right:10px;bottom:10px;width:280px;background:#fff;border:1px solid #ccc;z-index:10000;font-size:12px;display:flex;flex-direction:column;box-shadow:0 2px 10px rgba(0,0,0,.2)}
    #chatTabs{display:flex;border-bottom:1px solid #ddd;background:#f9f9f9}
    .chatTab{flex:1;text-align:center;padding:6px;cursor:pointer;border-right:1px solid #ddd;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .chatTab.active{background:#3498db;color:#fff}
    #chatBox{height:160px;overflow-y:auto;padding:6px}
    #chatInput{width:100%;border:none;border-top:1px solid #ddd;padding:10px;box-sizing:border-box;outline:none}
    #debugBtn{position:fixed;left:10px;top:10px;z-index:10000;background:#3498db;color:#fff;border:none;border-radius:4px;padding:6px 10px;cursor:pointer}
    #debugPanel{position:fixed;left:10px;top:50px;width:220px;background:#fff;border:1px solid #ccc;z-index:10000;padding:10px;display:none;font-size:12px}
    #debugPanel select{width:100%;margin:4px 0}
    .pmHint{background:#fff;padding:4px 6px;border:1px solid #3498db;font-size:12px;cursor:pointer;color:#3498db}
</style>
</head>
<body>

<div id="map"></div>

<button id="debugBtn">âš™ è°ƒè¯•é¢æ¿</button>
<div id="debugPanel">
    <b>å®šä½æ¨¡å¼</b>
    <select id="locMode">
        <option value="manual">æ‰‹åŠ¨æ‰“æ ‡</option>
        <option value="gps">GPS å®šä½</option>
    </select>
    <b>å¯è§èŒƒå›´</b>
    <select id="rangeSelect">
        <option value="200">200m</option>
        <option value="500">500m</option>
        <option value="1000" selected>1km</option>
        <option value="2000">2km</option>
        <option value="5000">5km</option>
    </select>
</div>

<div id="loginMask">
    <div id="loginBox">
        <h3>MomentMap ç™»å½•</h3>
        <input id="usernameInput" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" maxlength="12"/>
        <button id="loginBtn">è¿›å…¥åœ°å›¾</button>
    </div>
</div>

<div id="chatPanel" style="display:none">
    <div id="chatTabs"></div>
    <div id="chatBox"></div>
    <input id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯åå›è½¦å‘é€" autocomplete="off"/>
</div>

<script src="https://map.qq.com/api/js?v=2.exp&key=OB4BZ-D4W3U-B7VVO-4PJWW-6TKDJ-WPB77&libraries=geometry"></script>

<script>
    /* =======================
        å…¬ç½‘æ­£å¼ç¯å¢ƒé…ç½®
       ======================= */
    const WS_URL = "wss://api.mapnow.ggff.net/ws";

    let map, socket, currentUser;
    let myPos = null, visibleRange = 1000;
    let users = [];
    let markers = {}, ranges = {};
    let currentTab = "public";
    let chats = { public: [] };
    let pingInterval;

    window.onload = () => {
        map = new qq.maps.Map(document.getElementById("map"), {
            center: new qq.maps.LatLng(31.28, 121.5),
            zoom: 14,
            keyboardShortcuts: false
        });

        qq.maps.event.addListener(map, "click", e => {
            if (document.getElementById("locMode").value !== "manual") return;
            updateMyPos(e.latLng.getLat(), e.latLng.getLng());
            sendPosition();
        });

        document.getElementById("chatInput").addEventListener("keydown", e => {
            if (e.key === "Enter") sendChat();
        });

        document.getElementById("rangeSelect").onchange = e => {
            visibleRange = parseInt(e.target.value);
            updateRange();
            refreshMarkers();
            sendPosition();
        };

        document.getElementById("debugBtn").onclick = () => {
            const p = document.getElementById("debugPanel");
            p.style.display = p.style.display === "none" ? "block" : "none";
        };

        document.getElementById("loginBtn").onclick = login;
    };

    function login() {
        currentUser = document.getElementById("usernameInput").value.trim();
        if (!currentUser) return;

        console.log("ğŸš€ å°è¯•è¿æ¥åˆ°å…¬ç½‘ WSS:", WS_URL);
        socket = new WebSocket(WS_URL);

        socket.onopen = () => {
            console.log("âœ… WebSocket è¿æ¥æˆåŠŸ");
            document.getElementById("loginMask").style.display = "none";
            document.getElementById("chatPanel").style.display = "flex";
            addTab("public", "å…¬å±");
            
            socket.send(JSON.stringify({
                type: "login",
                username: currentUser
            }));

            // æ¯ 10 ç§’å¿ƒè·³ï¼Œé˜²æ–­è¿
            if(pingInterval) clearInterval(pingInterval);
            pingInterval = setInterval(() => {
                if(socket.readyState === 1) socket.send(JSON.stringify({type:"ping"}));
            }, 10000);
        };

        socket.onmessage = e => {
            const d = JSON.parse(e.data);
            if (d.type === "users") {
                users = d.list;
                refreshMarkers();
            }
            if (d.type === "chat") {
                const key = d.to ? (d.from === currentUser ? d.to : d.from) : "public";
                if (!chats[key]) {
                    chats[key] = [];
                    addTab(key, key);
                }
                chats[key].push(`${d.from}ï¼š${d.msg}`);
                if (key === currentTab) renderChat();
            }
        };

        socket.onclose = (event) => {
            console.warn("âš ï¸ è¿æ¥å…³é—­:", event.code);
            if(pingInterval) clearInterval(pingInterval);
        };

        socket.onerror = (err) => {
            console.error("âŒ WebSocket é”™è¯¯:", err);
        };
    }

    function updateMyPos(lat, lng) {
        myPos = { lat, lng };
        updateRange();
        refreshMarkers();
    }

    function sendPosition() {
        if (socket?.readyState === 1 && myPos) {
            socket.send(JSON.stringify({
                type: "position",
                lat: myPos.lat,
                lng: myPos.lng
            }));
        }
    }

    function updateRange() {
        if (!myPos) return;
        ranges.self?.setMap(null);
        ranges.self = new qq.maps.Circle({
            map,
            center: new qq.maps.LatLng(myPos.lat, myPos.lng),
            radius: visibleRange,
            fillColor: new qq.maps.Color(52, 152, 219, 0.3),
            strokeWeight: 1
        });
    }

    function refreshMarkers() {
        if (!myPos) return;
        const me = new qq.maps.LatLng(myPos.lat, myPos.lng);
        if (!markers[currentUser]) {
            markers[currentUser] = new qq.maps.Marker({
                map, position: me,
                label: { content: currentUser, offset: new qq.maps.Size(0, -20) }
            });
        } else {
            markers[currentUser].setPosition(me);
            markers[currentUser].setMap(map);
        }

        users.forEach(u => {
            if (u.username === currentUser || !u.lat) return;
            const pos = new qq.maps.LatLng(u.lat, u.lng);
            const dist = qq.maps.geometry.spherical.computeDistanceBetween(me, pos);
            if (dist > visibleRange) {
                markers[u.username]?.setMap(null);
                return;
            }
            if (!markers[u.username]) {
                markers[u.username] = new qq.maps.Marker({
                    map, position: pos,
                    label: { content: u.username, offset: new qq.maps.Size(0, -20) }
                });
            } else {
                markers[u.username].setPosition(pos);
                markers[u.username].setMap(map);
            }
        });
    }

    function addTab(key, name) {
        if (document.getElementById("tab-" + key)) return;
        const t = document.createElement("div");
        t.className = "chatTab";
        t.id = "tab-" + key;
        t.innerText = name;
        t.onclick = () => switchTab(key);
        document.getElementById("chatTabs").appendChild(t);
    }

    function switchTab(key) {
        currentTab = key;
        document.querySelectorAll(".chatTab").forEach(t => t.classList.remove("active"));
        document.getElementById("tab-" + key)?.classList.add("active");
        renderChat();
    }

    function renderChat() {
        const box = document.getElementById("chatBox");
        box.innerHTML = (chats[currentTab] || []).map(m => `<div>${m}</div>`).join("");
        box.scrollTop = box.scrollHeight;
    }

    function sendChat() {
        const input = document.getElementById("chatInput");
        const msg = input.value.trim();
        if (!msg || !socket || socket.readyState !== 1) return;
        socket.send(JSON.stringify({
            type: "chat",
            msg,
            to: currentTab === "public" ? null : currentTab
        }));
        input.value = "";
    }
</script>
</body>
</html>
