<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>æ­¤åˆ»åœ°å›¾1.5.1-WEB-0.1</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
html,body{margin:0;height:100%;overflow:hidden;font-family:Arial}
#map{width:100%;height:100%}

/* ç™»å½• */
#loginMask{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:flex;align-items:center;justify-content:center;z-index:9999
}
#loginBox{background:#fff;padding:20px;width:260px;border-radius:6px}
#loginBox input,#loginBox button{width:100%;padding:8px;margin-top:8px}

/* èŠå¤© */
#chatPanel{
  position:fixed;right:10px;bottom:10px;width:280px;
  background:#fff;border:1px solid #ccc;z-index:9999;font-size:12px
}
#chatTabs{display:flex;border-bottom:1px solid #ddd}
.chatTab{
  flex:1;text-align:center;padding:6px;cursor:pointer;
  border-right:1px solid #ddd
}
.chatTab.active{background:#3498db;color:#fff}
#chatBox{height:160px;overflow-y:auto;padding:6px}
#chatInput{width:100%;border:none;border-top:1px solid #ddd;padding:6px}

/* è°ƒè¯• */
#debugBtn{
  position:fixed;left:10px;top:10px;
  z-index:9999;background:#3498db;color:#fff;
  border:none;border-radius:4px;padding:6px 10px;cursor:pointer
}
#debugPanel{
  position:fixed;left:10px;top:50px;
  width:220px;background:#fff;border:1px solid #ccc;
  z-index:9999;padding:10px;display:none;font-size:12px
}
#debugPanel select{width:100%;margin:4px 0}

/* ç§èŠæç¤º */
.pmHint{
  background:#fff;padding:4px 6px;
  border:1px solid #3498db;
  font-size:12px;cursor:pointer
}
</style>
</head>

<body>

<div id="map"></div>

<button id="debugBtn">âš™ è°ƒè¯•</button>
<div id="debugPanel">
  <b>å®šä½æ¨¡å¼</b>
  <select id="locMode">
    <option value="manual">æ‰‹åŠ¨æ‰“æ ‡</option>
    <option value="gps">GPS å®šä½</option>
  </select>
  <b>å¯è§èŒƒå›´</b>
  <select id="rangeSelect">
    <option value="200">200m</option>
    <option value="500">500m</option>
    <option value="1000" selected>1km</option>
    <option value="2000">2km</option>
    <option value="5000">5km</option>
  </select>
</div>

<div id="loginMask">
  <div id="loginBox">
    <h3>ç™»å½•</h3>
    <input id="usernameInput" placeholder="ç”¨æˆ·å"/>
    <button id="loginBtn">è¿›å…¥</button>
  </div>
</div>

<div id="chatPanel" style="display:none">
  <div id="chatTabs"></div>
  <div id="chatBox"></div>
  <input id="chatInput" placeholder="å›è½¦å‘é€"/>
</div>

<!-- åŠ è½½ geometry æ¨¡å— -->
<script src="https://map.qq.com/api/js?v=2.exp&key=OB4BZ-D4W3U-B7VVO-4PJWW-6TKDJ-WPB77&libraries=geometry"></script>

<script>
let map,socket,currentUser;
let myPos=null,visibleRange=1000;
let users=[];
let markers={},ranges={};
let currentTab="public";
let chats={ public:[] };

window.onload=()=>{
  map=new qq.maps.Map(document.getElementById("map"),{
    center:new qq.maps.LatLng(31.28,121.5),zoom:14
  });

  qq.maps.event.addListener(map,"click",e=>{
    if(locMode.value!=="manual")return;
    updateMyPos(e.latLng.getLat(),e.latLng.getLng());
    sendPosition();
  });

  debugBtn.onclick=()=>debugPanel.style.display=
    debugPanel.style.display==="none"?"block":"none";

  rangeSelect.onchange=e=>{
    visibleRange=parseInt(e.target.value);
    updateRange();
    refreshMarkers();
    sendPosition();
  };

  locMode.onchange=e=>e.target.value==="gps"&&useGPS();
  loginBtn.onclick=login;
  chatInput.onkeydown=e=>e.key==="Enter"&&sendChat();
};

/* ========= ç™»å½• & WS ========= */
function login(){
  currentUser=usernameInput.value.trim();
  if(!currentUser)return;
  const protocol = location.protocol === "https:" ? "wss" : "ws";
socket = new WebSocket(`${protocol}://ws.mapnow.ggff.net`);


  socket.onopen=()=>{
    loginMask.style.display="none";
    chatPanel.style.display="block";
    addTab("public","å…¬å±");
    socket.send(JSON.stringify({type:"login",username:currentUser}));
  };

  socket.onmessage=e=>{
    const d=JSON.parse(e.data);
    console.log("ğŸ“©",d);

    if(d.type==="users"){
      users=d.list;
      refreshMarkers();
    }

    if(d.type==="chat"){
      const key = d.to
        ? (d.from===currentUser ? d.to : d.from)
        : "public";

      if(!chats[key]){
        chats[key]=[];
        addTab(key,key);
      }

      chats[key].push(`${d.from}ï¼š${d.msg}`);
      if(key===currentTab)renderChat();
    }
  };
}

/* ========= å®šä½ ========= */
function updateMyPos(lat,lng){
  myPos={lat,lng};
  updateRange();
  refreshMarkers();
}

function useGPS(){
  navigator.geolocation.getCurrentPosition(p=>{
    updateMyPos(p.coords.latitude,p.coords.longitude);
    map.setCenter(new qq.maps.LatLng(myPos.lat,myPos.lng));
    sendPosition();
  });
}

function sendPosition(){
  if(socket && myPos){
    socket.send(JSON.stringify({
      type:"position",
      lat: myPos.lat,
      lng: myPos.lng
    }));
  }
}

function updateRange(){
  if(!myPos)return;
  if(ranges.self)ranges.self.setMap(null);
  ranges.self=new qq.maps.Circle({
    map,
    center:new qq.maps.LatLng(myPos.lat,myPos.lng),
    radius:visibleRange,
    fillColor:new qq.maps.Color(52,152,219,0.3)
  });
}

/* ========= Marker ========= */
function refreshMarkers() {
  if (!myPos) return;

  const myLatLng = new qq.maps.LatLng(myPos.lat, myPos.lng);

  // è‡ªå·±çš„ marker
  if (!markers[currentUser]) {
    markers[currentUser] = new qq.maps.Marker({
      map,
      position: myLatLng,
      label: { content: currentUser, offset: new qq.maps.Size(0, -20) }
    });
  } else {
    markers[currentUser].setPosition(myLatLng);
    markers[currentUser].setMap(map);
  }

  // è“è‰²å¯è§èŒƒå›´
  updateRange();

  // å…¶ä»–ç”¨æˆ·
  users.forEach(u => {
    if (u.username === currentUser) return;
    if (!u.lat || !u.lng) return;

    const theirLatLng = new qq.maps.LatLng(u.lat, u.lng);

    // è®¡ç®—è·ç¦»
    const distToMe = qq.maps.geometry.spherical.computeDistanceBetween(myLatLng, theirLatLng);
    const distToThem = qq.maps.geometry.spherical.computeDistanceBetween(theirLatLng, myLatLng);

    // åŒæ–¹äº’ç›¸è¦†ç›–
    const visible = distToMe <= visibleRange && distToThem <= (u.range || 1000);

    if (!visible) {
      if (markers[u.username]) markers[u.username].setMap(null);
      return;
    }

    if (!markers[u.username]) {
      // åˆ›å»º marker
      markers[u.username] = new qq.maps.Marker({
        map,
        position: theirLatLng,
        label: { content: u.username, offset: new qq.maps.Size(0, -20) }
      });

      qq.maps.event.addListener(markers[u.username], "mouseover", () => {
        showPM(u.username, theirLatLng);
      });
    } else {
      // æ›´æ–°ä½ç½®å¹¶ç¡®ä¿æ˜¾ç¤º
      markers[u.username].setPosition(theirLatLng);
      markers[u.username].setMap(map);
    }
  });
}

function showPM(user,pos){
  const info=new qq.maps.InfoWindow({
    map,
    position:pos,
    content:`<div class="pmHint">ç§èŠ</div>`
  });
  info.open();
  qq.maps.event.addListenerOnce(info,"domready",()=>{
    document.querySelector(".pmHint").onclick=()=>{
      openPrivate(user);
      info.close();
    };
  });
}

/* ========= èŠå¤© UI ========= */
function openPrivate(user){
  if(!chats[user])chats[user]=[];
  addTab(user,user);
  switchTab(user);
}

function addTab(key,name){
  if(document.getElementById("tab-"+key))return;
  const t=document.createElement("div");
  t.className="chatTab";
  t.id="tab-"+key;
  t.innerText=name;
  t.onclick=()=>switchTab(key);
  chatTabs.appendChild(t);
}

function switchTab(key){
  currentTab=key;
  document.querySelectorAll(".chatTab")
    .forEach(t=>t.classList.remove("active"));
  document.getElementById("tab-"+key)
    .classList.add("active");
  renderChat();
}

function renderChat(){
  chatBox.innerHTML=(chats[currentTab]||[])
    .map(m=>`<div>${m}</div>`).join("");
}

function sendChat(){
  const msg=chatInput.value.trim();
  if(!msg)return;
  socket.send(JSON.stringify({
    type:"chat",
    msg,
    to:currentTab==="public"?null:currentTab
  }));
  chatInput.value="";
}
</script>
</body>
</html>


