<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>MomentMap1.1 - Fixed</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
html,body{margin:0;height:100%;overflow:hidden;font-family:Arial}
#map{width:100%;height:100%;z-index:1}

/* 登录层 */
#loginMask{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:flex;align-items:center;justify-content:center;z-index:10001
}
#loginBox{background:#fff;padding:20px;width:260px;border-radius:6px}
#loginBox input,#loginBox button{width:100%;padding:8px;margin-top:8px;box-sizing:border-box}

/* 聊天面板 - 提升层级并确保交互 */
#chatPanel{
  position:fixed;right:10px;bottom:10px;width:280px;
  background:#fff;border:1px solid #ccc;z-index:10000;
  font-size:12px;display:flex;flex-direction:column;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}
#chatTabs{display:flex;border-bottom:1px solid #ddd;background:#f9f9f9}
.chatTab{
  flex:1;text-align:center;padding:6px;cursor:pointer;
  border-right:1px solid #ddd;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.chatTab.active{background:#3498db;color:#fff}
#chatBox{height:160px;overflow-y:auto;padding:6px;background:#fff}
#chatInput{
  width:100%;border:none;border-top:1px solid #ddd;
  padding:10px;box-sizing:border-box;outline:none;
}

/* 调试面板 */
#debugBtn{
  position:fixed;left:10px;top:10px;
  z-index:10000;background:#3498db;color:#fff;
  border:none;border-radius:4px;padding:6px 10px;cursor:pointer
}
#debugPanel{
  position:fixed;left:10px;top:50px;
  width:220px;background:#fff;border:1px solid #ccc;
  z-index:10000;padding:10px;display:none;font-size:12px
}
#debugPanel select{width:100%;margin:4px 0}

.pmHint{
  background:#fff;padding:4px 6px;
  border:1px solid #3498db;
  font-size:12px;cursor:pointer;color:#3498db;
}
</style>
</head>

<body>

<div id="map"></div>

<button id="debugBtn">⚙ 调试 20260130_1618版 </button>
<div id="debugPanel">
  <b>定位模式</b>
  <select id="locMode">
    <option value="manual">手动打标</option>
    <option value="gps">GPS 定位</option>
  </select>
  <b>可见范围</b>
  <select id="rangeSelect">
    <option value="200">200m</option>
    <option value="500">500m</option>
    <option value="1000" selected>1km</option>
    <option value="2000">2km</option>
    <option value="5000">5km</option>
  </select>
</div>

<div id="loginMask">
  <div id="loginBox">
    <h3>MomentMap 登录 </h3>
    <input id="usernameInput" placeholder="请输入用户名" maxlength="12"/>
    <button id="loginBtn">进入地图</button>
  </div>
</div>

<div id="chatPanel" style="display:none">
  <div id="chatTabs"></div>
  <div id="chatBox"></div>
  <input id="chatInput" placeholder="输入消息后回车发送" autocomplete="off"/>
</div>

<script src="https://map.qq.com/api/js?v=2.exp&key=OB4BZ-D4W3U-B7VVO-4PJWW-6TKDJ-WPB77&libraries=geometry"></script>

<script>
let map,socket,currentUser;
let myPos=null,visibleRange=1000;
let users=[];
let markers={},ranges={};
let currentTab="public";
let chats={ public:[] };

window.onload=()=>{
  // 初始化地图
  map = new qq.maps.Map(document.getElementById("map"),{
    center: new qq.maps.LatLng(31.28,121.5),
    zoom: 14,
    keyboardShortcuts: false // 尝试禁用地图原生键盘快捷键
  });

  qq.maps.event.addListener(map,"click",e=>{
    if(locMode.value!=="manual")return;
    updateMyPos(e.latLng.getLat(),e.latLng.getLng());
    sendPosition();
  });

  // 关键：防止聊天输入框的点击和按键被地图拦截
  const inputEl = document.getElementById("chatInput");
  
  inputEl.addEventListener('keydown', e => {
    e.stopPropagation(); // 阻止事件冒泡到地图
    if(e.key === "Enter") {
      sendChat();
    }
  });

  inputEl.addEventListener('mousedown', e => {
    e.stopPropagation();
    inputEl.focus();
  });

  debugBtn.onclick=()=>debugPanel.style.display=
    debugPanel.style.display==="none"?"block":"none";

  rangeSelect.onchange=e=>{
    visibleRange=parseInt(e.target.value);
    updateRange();
    refreshMarkers();
    sendPosition();
  };

  locMode.onchange=e=>e.target.value==="gps"&&useGPS();
  loginBtn.onclick=login;
};

/* ========= 登录 & WS ========= */
function login(){
  currentUser=usernameInput.value.trim();
  if(!currentUser)return;
  
  const protocol = location.protocol === "https:" ? "wss://" : "ws://";
  // 注意：如果你的 server.js 监听在 3000 端口且没有 Nginx 转发，这里需要加 :3000
  const wsUrl = protocol + location.host + "/ws/";
  
  socket = new WebSocket(wsUrl);

  socket.onopen=()=>{
    loginMask.style.display="none";
    chatPanel.style.display="flex";
    addTab("public","公屏");
    socket.send(JSON.stringify({type:"login",username:currentUser}));
  };

  socket.onmessage=e=>{
    const d=JSON.parse(e.data);
    if(d.type==="users"){
      users=d.list;
      refreshMarkers();
    }
    if(d.type==="chat"){
      const key = d.to ? (d.from===currentUser ? d.to : d.from) : "public";
      if(!chats[key]){
        chats[key]=[];
        addTab(key,key);
      }
      chats[key].push(`${d.from}：${d.msg}`);
      if(key===currentTab) renderChat();
    }
  };

  socket.onclose=()=> {
    alert("连接已断开，请刷新页面");
  };
}

/* ========= 定位逻辑保持不变 ========= */
function updateMyPos(lat,lng){
  myPos={lat,lng};
  updateRange();
  refreshMarkers();
}

function useGPS(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(p=>{
      updateMyPos(p.coords.latitude,p.coords.longitude);
      map.setCenter(new qq.maps.LatLng(myPos.lat,myPos.lng));
      sendPosition();
    }, err => alert("GPS获取失败"));
  }
}

function sendPosition(){
  if(socket && socket.readyState === WebSocket.OPEN && myPos){
    socket.send(JSON.stringify({
      type:"position",
      lat: myPos.lat,
      lng: myPos.lng
    }));
  }
}

function updateRange(){
  if(!myPos)return;
  if(ranges.self)ranges.self.setMap(null);
  ranges.self=new qq.maps.Circle({
    map,
    center:new qq.maps.LatLng(myPos.lat,myPos.lng),
    radius:visibleRange,
    fillColor:new qq.maps.Color(52,152,219,0.3),
    strokeWeight: 1
  });
}

function refreshMarkers() {
  if (!myPos) return;
  const myLatLng = new qq.maps.LatLng(myPos.lat, myPos.lng);

  if (!markers[currentUser]) {
    markers[currentUser] = new qq.maps.Marker({
      map,
      position: myLatLng,
      label: { content: currentUser, offset: new qq.maps.Size(0, -20) }
    });
  } else {
    markers[currentUser].setPosition(myLatLng);
    markers[currentUser].setMap(map);
  }

  users.forEach(u => {
    if (u.username === currentUser || !u.lat || !u.lng) return;
    const theirLatLng = new qq.maps.LatLng(u.lat, u.lng);
    const distToMe = qq.maps.geometry.spherical.computeDistanceBetween(myLatLng, theirLatLng);
    const visible = distToMe <= visibleRange;

    if (!visible) {
      if (markers[u.username]) markers[u.username].setMap(null);
      return;
    }

    if (!markers[u.username]) {
      markers[u.username] = new qq.maps.Marker({
        map,
        position: theirLatLng,
        label: { content: u.username, offset: new qq.maps.Size(0, -20) }
      });
      qq.maps.event.addListener(markers[u.username], "mouseover", () => showPM(u.username, theirLatLng));
    } else {
      markers[u.username].setPosition(theirLatLng);
      markers[u.username].setMap(map);
    }
  });
}

function showPM(user,pos){
  const info=new qq.maps.InfoWindow({
    map,
    position:pos,
    content:`<div class="pmHint">私聊 ${user}</div>`
  });
  info.open();
  qq.maps.event.addListenerOnce(info,"domready",()=>{
    document.querySelector(".pmHint").onclick=()=>{
      openPrivate(user);
      info.close();
    };
  });
}

/* ========= 聊天 UI 逻辑 ========= */
function openPrivate(user){
  if(!chats[user])chats[user]=[];
  addTab(user,user);
  switchTab(user);
}

function addTab(key,name){
  if(document.getElementById("tab-"+key))return;
  const t=document.createElement("div");
  t.className="chatTab";
  t.id="tab-"+key;
  t.innerText=name;
  t.onclick=(e)=>{
    e.stopPropagation();
    switchTab(key);
  }
  chatTabs.appendChild(t);
}

function switchTab(key){
  currentTab=key;
  document.querySelectorAll(".chatTab").forEach(t=>t.classList.remove("active"));
  const target = document.getElementById("tab-"+key);
  if(target) target.classList.add("active");
  renderChat();
}

function renderChat(){
  chatBox.innerHTML=(chats[currentTab]||[])
    .map(m=>`<div style="margin-bottom:4px;word-break:break-all;">${m}</div>`).join("");
  chatBox.scrollTop = chatBox.scrollHeight;
}

function sendChat(){
  const input = document.getElementById("chatInput");
  const msg=input.value.trim();
  if(!msg || !socket) return;
  
  socket.send(JSON.stringify({
    type:"chat",
    msg,
    to:currentTab==="public"?null:currentTab
  }));
  input.value="";
}
</script>
</body>
</html>
