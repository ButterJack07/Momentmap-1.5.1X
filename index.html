<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ°”æ³¡ä¸å…¬å±èŠå¤©æµ‹è¯• 1.2</title>
    <style>
        /* ==================== å…¨å±€æ ·å¼ ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: #021024;
            color: white;
            touch-action: pan-x pan-y;
        }

        /* ==================== é¡¶éƒ¨çŠ¶æ€æ  ==================== */
        .status-bar {
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1000;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info span {
            font-size: 14px;
            font-weight: 500;
        }

        #userNickname {
            font-weight: bold;
        }

        #userId {
            font-size: 12px;
            opacity: 0.8;
        }

        .connection-status {
            padding: 5px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            font-size: 12px;
        }

        /* ä½ç½®çŠ¶æ€ */
        .location-status {
            padding: 5px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .location-status:hover {
            background: rgba(255,255,255,0.2);
        }

        /* å³ä¾§é¢æ¿æ§åˆ¶æŒ‰é’® */
        .panel-toggle-btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .panel-toggle-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        /* ==================== ä¸»å®¹å™¨ ==================== */
        .container {
            display: flex;
            height: calc(100vh - 60px);
            overflow: hidden;
        }

        /* ==================== å·¦ä¾§ï¼šåœ°å›¾åŒºåŸŸ ==================== */
        .map-container {
            flex: 1;
            position: relative;
            min-width: 0;
            transition: all 0.3s ease;
        }

        .map-container.full-width {
            flex: 1;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #0a1929;
        }

        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .map-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(245,245,245,0.95) 100%);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-weight: 600;
            color: #052659;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .map-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        /* ä½ç½®é€‰æ‹©æ¨¡å¼åˆ‡æ¢ */
        .location-mode {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .location-mode-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(245,245,245,0.95) 100%);
            border: none;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-weight: 600;
            color: #052659;
            font-size: 13px;
            transition: all 0.3s ease;
            text-align: left;
        }

        .location-mode-btn.active {
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(84, 131, 179, 0.3);
        }

        .location-mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        /* ==================== å³ä¾§ï¼šæ§åˆ¶é¢æ¿ ==================== */
        .control-panel {
            flex: 0 0 400px;
            background: rgba(255, 255, 255, 0.98);
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(84, 131, 179, 0.2);
            transition: all 0.3s ease;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .control-panel.collapsed {
            flex: 0 0 0;
            min-width: 0;
            opacity: 0;
            visibility: hidden;
        }

        /* ==================== åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ ==================== */
        .online-users {
            padding: 20px;
            border-bottom: 1px solid rgba(84, 131, 179, 0.2);
            max-height: 200px;
            overflow-y: auto;
            background: white;
        }

        .online-users h3 {
            color: #052659;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-item {
            padding: 10px 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            margin-bottom: 8px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 4px solid #5483B3;
            transition: all 0.3s ease;
        }

        .user-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* ==================== æ°”æ³¡åˆ—è¡¨ ==================== */
        .bubbles-list {
            flex: 1;
            padding: 20px;
            border-bottom: 1px solid rgba(84, 131, 179, 0.2);
            overflow-y: auto;
            background: white;
        }

        .bubbles-list h3 {
            color: #052659;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bubble-item {
            padding: 15px;
            background: linear-gradient(135deg, #f0f7ff 0%, #e6f0ff 100%);
            margin-bottom: 12px;
            border-radius: 12px;
            border-left: 4px solid #5483B3;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .bubble-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(84, 131, 179, 0.15);
        }

        .bubble-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .bubble-type {
            font-size: 11px;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ==================== å‘å¸ƒæ°”æ³¡è¡¨å• ==================== */
        .publish-form {
            padding: 20px;
            background: white;
            border-top: 1px solid rgba(84, 131, 179, 0.2);
        }

        .publish-form h3 {
            color: #052659;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bubble-types {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .bubble-type-btn {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #052659;
        }

        .bubble-type-btn.selected {
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
            color: white;
            border-color: #5483B3;
            box-shadow: 0 4px 12px rgba(84, 131, 179, 0.3);
        }

        .publish-form input,
        .publish-form textarea {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            outline: none;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .publish-form input:focus,
        .publish-form textarea:focus {
            border-color: #5483B3;
            background: white;
            box-shadow: 0 0 0 3px rgba(84, 131, 179, 0.1);
        }

        .publish-form textarea {
            min-height: 80px;
            resize: vertical;
        }

        .publish-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .publish-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(84, 131, 179, 0.4);
        }

        /* ==================== åº•éƒ¨å±…ä¸­ï¼šå…¬å±èŠå¤©é¢æ¿ ==================== */
        .chat-panel {
            position: fixed;
            left: 50%;
            bottom: 20px;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            z-index: 9500;
            display: none;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(84, 131, 179, 0.2);
        }

        .chat-header {
            padding: 15px;
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
            color: white;
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-messages {
            flex: 1;
            max-height: 200px;
            padding: 15px;
            overflow-y: auto;
            background: white;
            -webkit-overflow-scrolling: touch;
        }

        .chat-message {
            margin-bottom: 12px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 12px;
            font-size: 13px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message .sender {
            font-weight: 600;
            color: #5483B3;
            margin-bottom: 5px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .chat-message .time {
            font-size: 11px;
            color: #6c757d;
            text-align: right;
            margin-top: 4px;
        }

        .chat-message.my-message {
            background: linear-gradient(135deg, #e6f0ff 0%, #c1e8ff 100%);
            border-left: 4px solid #5483B3;
        }

        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            background: white;
        }

        .chat-input-area input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .chat-input-area input:focus {
            border-color: #5483B3;
            background: white;
            box-shadow: 0 0 0 3px rgba(84, 131, 179, 0.1);
        }

        .chat-input-area button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .chat-input-area button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(84, 131, 179, 0.3);
        }

        /* ==================== èŠå¤©åˆ‡æ¢æŒ‰é’® ==================== */
        .chat-toggle-btn {
            position: fixed;
            left: 50%;
            bottom: 20px;
            transform: translateX(-50%);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 9400;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .chat-toggle-btn:hover {
            transform: translateX(-50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* ==================== æ°”æ³¡é¢œè‰²å®šä¹‰ ==================== */
        .bubble-recommend { background: linear-gradient(135deg, #FF4444 0%, #CC0000 100%); }
        .bubble-help { background: linear-gradient(135deg, #FFD700 0%, #FFAA00 100%); color: #333; }
        .bubble-team { background: linear-gradient(135deg, #4169E1 0%, #1E40AF 100%); }
        .bubble-warning { background: linear-gradient(135deg, #9932CC 0%, #6B21A8 100%); }
        .bubble-news { background: linear-gradient(135deg, #FF69B4 0%, #DB2777 100%); }

        /* ==================== ç½‘ç»œçŠ¶æ€æç¤º ==================== */
        .network-status {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 10000;
            font-size: 14px;
            display: none;
            backdrop-filter: blur(10px);
            max-width: 80%;
            text-align: center;
        }

        .network-status.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ==================== ä½ç½®é€‰æ‹©å¼¹çª— ==================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            color: #052659;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #052659;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6c757d;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #f8f9fa;
            color: #052659;
        }

        .location-search {
            margin-bottom: 20px;
        }

        .location-search input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            background: #f8f9fa;
            margin-bottom: 10px;
        }

        .location-search input:focus {
            border-color: #5483B3;
            background: white;
            box-shadow: 0 0 0 3px rgba(84, 131, 179, 0.1);
            outline: none;
        }

        .location-suggestions {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            background: white;
        }

        .suggestion-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .suggestion-item:hover {
            background: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-name {
            font-weight: 600;
            color: #052659;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .suggestion-address {
            font-size: 12px;
            color: #6c757d;
        }

        .confirm-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(84, 131, 179, 0.4);
        }

        /* ==================== æ»šåŠ¨æ¡ç¾åŒ– ==================== */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #4169E1 0%, #1E3A8A 100%);
        }

        /* ==================== æ‰‹æœºç«¯é€‚é… ==================== */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: calc(100vh - 60px);
            }
            
            .map-container {
                flex: 1;
                min-height: 50vh;
            }
            
            .control-panel {
                flex: 0 0 auto;
                max-height: 40vh;
                overflow-y: auto;
                min-width: 100%;
            }
            
            .control-panel.collapsed {
                max-height: 0;
                min-height: 0;
            }
            
            .map-controls {
                top: 10px;
                right: 10px;
                flex-direction: row;
                gap: 5px;
            }
            
            .map-btn {
                padding: 8px 15px;
                font-size: 12px;
            }
            
            .chat-panel {
                width: 95%;
                max-height: 50vh;
                bottom: 10px;
            }
            
            .chat-messages {
                max-height: 150px;
            }
            
            .chat-toggle-btn {
                bottom: 10px;
            }
            
            .status-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .user-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 2px;
            }
            
            .panel-toggle-btn {
                position: absolute;
                top: 50%;
                right: 10px;
                transform: translateY(-50%);
            }
            
            .status-bar {
                padding: 10px;
            }
            
            .publish-form {
                padding: 15px;
            }
            
            .bubble-types {
                gap: 5px;
            }
            
            .bubble-type-btn {
                padding: 6px 12px;
                font-size: 11px;
            }
            
            .network-status {
                top: 60px;
                padding: 8px 15px;
                font-size: 13px;
            }
            
            .location-status {
                display: none;
            }
        }

        /* ==================== å¹³æ¿ç«¯é€‚é… ==================== */
        @media (min-width: 769px) and (max-width: 1024px) {
            .control-panel {
                flex: 0 0 350px;
            }
            
            .chat-panel {
                width: 80%;
                max-width: 500px;
            }
        }

        /* ==================== ç”¨æˆ·ä½ç½®æ ‡è®°æ ·å¼ ==================== */
        .user-marker-me {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="status-bar">
        <div class="status-left">
            <div class="user-info">
                <span id="userNickname">æœªç™»å½•</span>
                <span id="userId">ID: ---</span>
            </div>
            <div class="connection-status">
                <span id="connectionStatus">âŒ æœªè¿æ¥</span>
            </div>
            <div class="location-status" id="locationStatus" onclick="openLocationModal()">
                <span id="locationText">ğŸ“ å®šä½ä¸­...</span>
            </div>
        </div>
        <button class="panel-toggle-btn" id="panelToggleBtn">æ”¶èµ·é¢æ¿</button>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- å·¦ä¾§ï¼šåœ°å›¾ -->
        <div class="map-container" id="mapContainer">
            <div id="map"></div>
            <div class="map-controls">
                <button class="map-btn" onclick="loginTestUser()">ç™»å½•æµ‹è¯•ç”¨æˆ·</button>
                <button class="map-btn" onclick="clearAllBubbles()">æ¸…é™¤æ‰€æœ‰æ°”æ³¡</button>
                <div class="location-mode">
                    <button class="location-mode-btn active" id="gpsModeBtn" onclick="setLocationMode('gps')">
                        ğŸ“ GPSå®šä½
                    </button>
                    <button class="location-mode-btn" id="manualModeBtn" onclick="setLocationMode('manual')">
                        ğŸ¯ æ‰‹åŠ¨é€‰æ‹©ä½ç½®
                    </button>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šæ§åˆ¶é¢æ¿ -->
        <div class="control-panel" id="controlPanel">
            <!-- åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ -->
            <div class="online-users">
                <h3>ğŸ‘¥ åœ¨çº¿ç”¨æˆ·</h3>
                <div id="onlineUsersList">
                    <!-- åŠ¨æ€ç”Ÿæˆåœ¨çº¿ç”¨æˆ· -->
                </div>
            </div>

            <!-- æ°”æ³¡åˆ—è¡¨ -->
            <div class="bubbles-list">
                <h3>ğŸˆ æ°”æ³¡åˆ—è¡¨</h3>
                <div id="bubblesList">
                    <!-- åŠ¨æ€ç”Ÿæˆæ°”æ³¡ -->
                </div>
            </div>

            <!-- å‘å¸ƒæ°”æ³¡è¡¨å• -->
            <div class="publish-form">
                <h3>å‘å¸ƒæ–°æ°”æ³¡</h3>
                <div class="bubble-types">
                    <button class="bubble-type-btn" data-type="recommend" onclick="selectBubbleType('recommend')">æ¨è</button>
                    <button class="bubble-type-btn" data-type="help" onclick="selectBubbleType('help')">æ±‚åŠ©</button>
                    <button class="bubble-type-btn" data-type="team" onclick="selectBubbleType('team')">ç»„é˜Ÿ</button>
                    <button class="bubble-type-btn" data-type="warning" onclick="selectBubbleType('warning')">é¿é›·</button>
                    <button class="bubble-type-btn" data-type="news" onclick="selectBubbleType('news')">è§é—»</button>
                </div>
                <input type="text" id="bubbleTitle" placeholder="æ°”æ³¡æ ‡é¢˜">
                <textarea id="bubbleContent" placeholder="æ°”æ³¡å†…å®¹ï¼ˆå¯é€‰ï¼‰"></textarea>
                <div style="margin-bottom: 12px; font-size: 13px; color: #052659;">
                    å‘å¸ƒä½ç½®: <span id="publishLocationText">ğŸ“ ä½¿ç”¨å½“å‰ä½ç½®</span>
                </div>
                <button class="publish-btn" onclick="publishBubble()">å‘å¸ƒæ°”æ³¡</button>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å±…ä¸­ï¼šå…¬å±èŠå¤©é¢æ¿ -->
    <button class="chat-toggle-btn" id="chatToggleBtn" onclick="toggleChatPanel()">
        ğŸ’¬
        <span class="chat-badge" id="chatBadge" style="display: none;">0</span>
    </button>

    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <span>ğŸ’¬ å…¬å±èŠå¤©</span>
            <button onclick="toggleChatPanel()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">Ã—</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- åŠ¨æ€ç”ŸæˆèŠå¤©æ¶ˆæ¯ -->
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeydown="handleChatInputKey(event)" autocomplete="off">
            <button onclick="sendChatMessage()">å‘é€</button>
        </div>
    </div>

    <!-- ä½ç½®é€‰æ‹©å¼¹çª— -->
    <div class="modal" id="locationModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ“ é€‰æ‹©ä½ç½®</div>
                <button class="modal-close" onclick="closeLocationModal()">Ã—</button>
            </div>
            <div class="location-search">
                <input type="text" id="locationSearchInput" placeholder="æœç´¢åœ°ç‚¹..." oninput="searchLocation()">
                <div class="location-suggestions" id="locationSuggestions">
                    <!-- æœç´¢å»ºè®® -->
                </div>
            </div>
            <div style="text-align: center; margin: 20px 0;">
                <div style="font-size: 14px; color: #6c757d; margin-bottom: 10px;">æˆ–ç›´æ¥åœ¨åœ°å›¾ä¸Šç‚¹å‡»é€‰æ‹©ä½ç½®</div>
                <div id="selectedLocationInfo" style="padding: 15px; background: #f8f9fa; border-radius: 10px; font-size: 13px;">
                    å½“å‰ä½ç½®: ç­‰å¾…é€‰æ‹©...
                </div>
            </div>
            <button class="confirm-btn" onclick="confirmLocation()">ç¡®è®¤é€‰æ‹©</button>
        </div>
    </div>

    <!-- ç½‘ç»œçŠ¶æ€æç¤º -->
    <div class="network-status" id="networkStatus"></div>

    <!-- åœ°å›¾API -->
    <script src="https://map.qq.com/api/js?v=2.exp&key=OB4BZ-D4W3U-JSP5Z-4SFQE-O5CWRQ-CFB47"></script>
    
    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        const WS_URL = "ws://121.199.161.5:3000";
        let socket = null;
        let map = null;
        let currentUser = null;
        let myPosition = { lat: 31.2800, lng: 121.5000 };
        let selectedBubbleType = "recommend";
        let bubbles = [];
        let chatMessages = [];
        let chatPanelVisible = false;
        let unreadCount = 0;
        let panelCollapsed = false;

        // ä½ç½®ç›¸å…³å˜é‡
        let locationMode = 'gps'; // 'gps' æˆ– 'manual'
        let manualPosition = null;
        let gpsPosition = null;
        let isLocationEnabled = false;
        let gpsWatchId = null;
        
        // åœ°å›¾æ ‡è®°
        let myMarker = null;
        let userMarkers = {}; // å­˜å‚¨å…¶ä»–ç”¨æˆ·çš„æ ‡è®°
        let locationMapClickHandler = null;
        
        // å­˜å‚¨å·²å‘é€çš„æ¶ˆæ¯IDï¼Œé¿å…å›å£°é—®é¢˜
        let sentMessageIds = new Set();

        // ==================== åˆå§‹åŒ– ====================
        window.onload = function() {
            console.log("ğŸš€ æ°”æ³¡ä¸å…¬å±èŠå¤©æµ‹è¯• 1.2 å·²åŠ è½½");
            
            initMap();
            initEventListeners();
            
            // å°è¯•è·å–GPSä½ç½®
            getGPSLocation();
            
            // æ·»åŠ ä¸€äº›åˆå§‹èŠå¤©æ¶ˆæ¯
            setTimeout(() => {
                addChatMessage({
                    from: "ç³»ç»Ÿ",
                    avatar: "ğŸ¤–",
                    text: "æ¬¢è¿ä½¿ç”¨æ°”æ³¡ä¸å…¬å±èŠå¤©æµ‹è¯• 1.2ï¼ç‚¹å‡»å·¦ä¸Šè§’æŒ‰é’®ç™»å½•ç”¨æˆ·ï¼Œç„¶åå¯ä»¥å‘å¸ƒæ°”æ³¡å’Œå‘é€æ¶ˆæ¯ã€‚",
                    time: Date.now(),
                    isSystem: true
                });
            }, 500);
            
            // åˆå§‹åŠ è½½æµ‹è¯•ç”¨æˆ·
            setTimeout(() => {
                loginTestUser();
            }, 1000);
        };

        // ==================== äº‹ä»¶ç›‘å¬åˆå§‹åŒ– ====================
        function initEventListeners() {
            // é¢æ¿åˆ‡æ¢æŒ‰é’®
            document.getElementById('panelToggleBtn').addEventListener('click', togglePanel);
            
            // çª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´å¸ƒå±€
            window.addEventListener('resize', handleResize);
            
            // ä½ç½®æœç´¢è¾“å…¥æ¡†äº‹ä»¶
            document.getElementById('locationSearchInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    searchLocation();
                }
            });
        }

        // ==================== å“åº”å¼å¸ƒå±€å¤„ç† ====================
        function handleResize() {
            if (window.innerWidth <= 768) {
                // æ‰‹æœºç«¯ï¼šè‡ªåŠ¨è°ƒæ•´å¸ƒå±€
                document.body.classList.add('mobile');
            } else {
                document.body.classList.remove('mobile');
            }
        }

        // ==================== é¢æ¿æ”¶èµ·/å±•å¼€åŠŸèƒ½ ====================
        function togglePanel() {
            const panel = document.getElementById('controlPanel');
            const mapContainer = document.getElementById('mapContainer');
            const toggleBtn = document.getElementById('panelToggleBtn');
            
            panelCollapsed = !panelCollapsed;
            
            if (panelCollapsed) {
                panel.classList.add('collapsed');
                mapContainer.classList.add('full-width');
                toggleBtn.textContent = 'å±•å¼€é¢æ¿';
            } else {
                panel.classList.remove('collapsed');
                mapContainer.classList.remove('full-width');
                toggleBtn.textContent = 'æ”¶èµ·é¢æ¿';
            }
        }

        // ==================== åœ°å›¾åˆå§‹åŒ– ====================
        function initMap() {
            map = new qq.maps.Map(document.getElementById('map'), {
                center: new qq.maps.LatLng(myPosition.lat, myPosition.lng),
                zoom: 15,
                backgroundColor: '#0a1929',
                mapStyle: {
                    styleId: 'dark'
                }
            });

            console.log("âœ… åœ°å›¾åˆå§‹åŒ–å®Œæˆ");
            
            // æ·»åŠ åœ°å›¾ç‚¹å‡»äº‹ä»¶ï¼ˆç”¨äºæ‰‹åŠ¨é€‰æ‹©ä½ç½®ï¼‰
            map.addListener('click', handleMapClick);
        }

        // ==================== ä½ç½®æ¨¡å¼è®¾ç½® ====================
        function setLocationMode(mode) {
            locationMode = mode;
            
            const gpsBtn = document.getElementById('gpsModeBtn');
            const manualBtn = document.getElementById('manualModeBtn');
            
            if (mode === 'gps') {
                gpsBtn.classList.add('active');
                manualBtn.classList.remove('active');
                
                // å¯ç”¨GPSå®šä½
                startGPSWatching();
                showNetworkStatus("å·²åˆ‡æ¢åˆ°GPSå®šä½æ¨¡å¼", 2000);
            } else {
                gpsBtn.classList.remove('active');
                manualBtn.classList.add('active');
                
                // åœæ­¢GPSç›‘æ§
                stopGPSWatching();
                
                // æç¤ºç”¨æˆ·ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®
                showNetworkStatus("è¯·ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®", 2000);
            }
            
            updateLocationDisplay();
        }

        // ==================== GPSå®šä½åŠŸèƒ½ ====================
        function getGPSLocation() {
            if (!navigator.geolocation) {
                showNetworkStatus("æµè§ˆå™¨ä¸æ”¯æŒGPSå®šä½", 3000);
                updateLocationStatus("âŒ GPSä¸æ”¯æŒ");
                return;
            }
            
            showNetworkStatus("æ­£åœ¨è·å–GPSä½ç½®...", 0);
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    gpsPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // å¦‚æœå½“å‰æ˜¯GPSæ¨¡å¼ï¼Œæ›´æ–°ä½ç½®
                    if (locationMode === 'gps') {
                        updateMyPosition(gpsPosition);
                    }
                    
                    updateLocationStatus("âœ… GPSå·²å®šä½");
                    showNetworkStatus(`GPSå®šä½æˆåŠŸ: ${gpsPosition.lat.toFixed(4)}, ${gpsPosition.lng.toFixed(4)}`, 2000);
                    
                    // å¼€å§‹æŒç»­ç›‘æ§GPSä½ç½®
                    startGPSWatching();
                },
                function(error) {
                    let errorMessage = "GPSå®šä½å¤±è´¥";
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = "è¯·å…è®¸æµè§ˆå™¨è®¿é—®ä½ç½®ä¿¡æ¯";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = "ä½ç½®ä¿¡æ¯ä¸å¯ç”¨";
                            break;
                        case error.TIMEOUT:
                            errorMessage = "å®šä½è¶…æ—¶";
                            break;
                    }
                    
                    showNetworkStatus(errorMessage, 3000);
                    updateLocationStatus("âŒ å®šä½å¤±è´¥");
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function startGPSWatching() {
            if (!navigator.geolocation || gpsWatchId) return;
            
            gpsWatchId = navigator.geolocation.watchPosition(
                function(position) {
                    gpsPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // å¦‚æœå½“å‰æ˜¯GPSæ¨¡å¼ï¼Œæ›´æ–°ä½ç½®
                    if (locationMode === 'gps') {
                        updateMyPosition(gpsPosition);
                    }
                    
                    updateLocationStatus("ğŸ“ å®æ—¶å®šä½ä¸­");
                },
                function(error) {
                    console.error("GPSç›‘æ§é”™è¯¯:", error);
                    updateLocationStatus("âŒ å®šä½å¤±è´¥");
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 30000
                }
            );
            
            isLocationEnabled = true;
        }

        function stopGPSWatching() {
            if (gpsWatchId && navigator.geolocation) {
                navigator.geolocation.clearWatch(gpsWatchId);
                gpsWatchId = null;
            }
            isLocationEnabled = false;
        }

        // ==================== æ‰‹åŠ¨ä½ç½®é€‰æ‹© ====================
        function handleMapClick(event) {
            if (locationMode === 'manual') {
                manualPosition = {
                    lat: event.latLng.getLat(),
                    lng: event.latLng.getLng()
                };
                
                updateMyPosition(manualPosition);
                showNetworkStatus(`å·²é€‰æ‹©ä½ç½®: ${manualPosition.lat.toFixed(4)}, ${manualPosition.lng.toFixed(4)}`, 2000);
                
                // æ›´æ–°ä½ç½®é€‰æ‹©å¼¹çª—ä¸­çš„ä¿¡æ¯
                if (document.getElementById('locationModal').style.display === 'flex') {
                    updateLocationModalInfo();
                }
            }
        }

        function updateMyPosition(position) {
            myPosition = position;
            
            // æ›´æ–°æˆ‘çš„ä½ç½®æ ‡è®°
            updateMyMarker();
            
            // æ›´æ–°åœ°å›¾ä¸­å¿ƒï¼ˆå¹³æ»‘ç§»åŠ¨ï¼‰
            if (map) {
                map.panTo(new qq.maps.LatLng(position.lat, position.lng));
            }
            
            // æ›´æ–°å‘å¸ƒä½ç½®æ˜¾ç¤º
            updatePublishLocationDisplay();
            
            // å‘é€ä½ç½®åˆ°æœåŠ¡å™¨
            sendPositionToServer();
        }

        function updateMyMarker() {
            if (!map) return;
            
            // ç§»é™¤æ—§çš„æ ‡è®°
            if (myMarker) {
                myMarker.setMap(null);
            }
            
            // åˆ›å»ºæ–°çš„æ ‡è®°
            const icon = new qq.maps.MarkerImage(
                'data:image/svg+xml;utf8,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">
                        <circle cx="24" cy="24" r="20" fill="#5483B3" stroke="white" stroke-width="3"/>
                        <circle cx="24" cy="24" r="10" fill="white"/>
                        <text x="24" y="32" text-anchor="middle" fill="white" font-size="20" font-family="Arial">ğŸ‘¤</text>
                    </svg>
                `),
                new qq.maps.Size(48, 48),
                new qq.maps.Point(0, 0),
                new qq.maps.Point(24, 24)
            );
            
            myMarker = new qq.maps.Marker({
                map: map,
                position: new qq.maps.LatLng(myPosition.lat, myPosition.lng),
                title: currentUser ? currentUser.nickname : 'æˆ‘çš„ä½ç½®',
                icon: icon,
                animation: qq.maps.MarkerAnimation.DROP
            });
            
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            myMarker.setAnimation(qq.maps.MarkerAnimation.BOUNCE);
            setTimeout(() => {
                myMarker.setAnimation(null);
            }, 1500);
        }

        // ==================== ä½ç½®å¼¹çª—åŠŸèƒ½ ====================
        function openLocationModal() {
            document.getElementById('locationModal').style.display = 'flex';
            document.getElementById('locationSearchInput').focus();
        }

        function closeLocationModal() {
            document.getElementById('locationModal').style.display = 'none';
            document.getElementById('locationSearchInput').value = '';
            document.getElementById('locationSuggestions').innerHTML = '';
        }

        function searchLocation() {
            const input = document.getElementById('locationSearchInput').value.trim();
            const suggestionsDiv = document.getElementById('locationSuggestions');
            
            if (!input) {
                suggestionsDiv.innerHTML = '<div class="suggestion-item"><div class="suggestion-name">è¯·è¾“å…¥æœç´¢å…³é”®è¯</div></div>';
                return;
            }
            
            // ä½¿ç”¨è…¾è®¯åœ°å›¾æœç´¢API
            const search = new qq.maps.Search({
                complete: function(results) {
                    suggestionsDiv.innerHTML = '';
                    
                    if (results.detail && results.detail.pois && results.detail.pois.length > 0) {
                        results.detail.pois.slice(0, 5).forEach(poi => {
                            const item = document.createElement('div');
                            item.className = 'suggestion-item';
                            item.innerHTML = `
                                <div class="suggestion-name">${poi.name}</div>
                                <div class="suggestion-address">${poi.address || 'æ— åœ°å€ä¿¡æ¯'}</div>
                            `;
                            item.onclick = () => selectLocationFromSearch(poi);
                            suggestionsDiv.appendChild(item);
                        });
                    } else {
                        suggestionsDiv.innerHTML = '<div class="suggestion-item"><div class="suggestion-name">æœªæ‰¾åˆ°ç›¸å…³åœ°ç‚¹</div></div>';
                    }
                }
            });
            
            search.search(input);
        }

        function selectLocationFromSearch(poi) {
            manualPosition = {
                lat: poi.latLng.lat,
                lng: poi.latLng.lng
            };
            
            // åˆ‡æ¢åˆ°æ‰‹åŠ¨æ¨¡å¼
            setLocationMode('manual');
            
            // æ›´æ–°ä½ç½®
            updateMyPosition(manualPosition);
            
            // æ›´æ–°å¼¹çª—ä¿¡æ¯
            updateLocationModalInfo();
            
            // å°†åœ°å›¾ä¸­å¿ƒç§»åŠ¨åˆ°é€‰æ‹©çš„ä½ç½®
            if (map) {
                map.panTo(new qq.maps.LatLng(manualPosition.lat, manualPosition.lng));
            }
            
            document.getElementById('locationSearchInput').value = poi.name;
            document.getElementById('locationSuggestions').innerHTML = '';
            
            showNetworkStatus(`å·²é€‰æ‹©: ${poi.name}`, 2000);
        }

        function updateLocationModalInfo() {
            const infoDiv = document.getElementById('selectedLocationInfo');
            const modeText = locationMode === 'gps' ? 'GPSå®šä½' : 'æ‰‹åŠ¨é€‰æ‹©';
            const posText = manualPosition || myPosition;
            
            infoDiv.innerHTML = `
                <div><strong>æ¨¡å¼:</strong> ${modeText}</div>
                <div><strong>ä½ç½®:</strong> ${posText.lat.toFixed(6)}, ${posText.lng.toFixed(6)}</div>
                <div><strong>çŠ¶æ€:</strong> ${isLocationEnabled ? 'å®æ—¶æ›´æ–°ä¸­' : 'æ‰‹åŠ¨ä½ç½®'}</div>
            `;
        }

        function confirmLocation() {
            closeLocationModal();
            showNetworkStatus("ä½ç½®å·²ç¡®è®¤", 2000);
        }

        // ==================== ä½ç½®çŠ¶æ€æ›´æ–° ====================
        function updateLocationStatus(text) {
            const element = document.getElementById('locationText');
            if (element) element.textContent = text;
        }

        function updatePublishLocationDisplay() {
            const element = document.getElementById('publishLocationText');
            if (element) {
                const modeText = locationMode === 'gps' ? 'GPSå®šä½' : 'æ‰‹åŠ¨é€‰æ‹©';
                element.textContent = `ğŸ“ ${modeText} (${myPosition.lat.toFixed(4)}, ${myPosition.lng.toFixed(4)})`;
            }
        }

        function updateLocationDisplay() {
            updateLocationStatus(locationMode === 'gps' ? 'ğŸ“ GPSå®šä½ä¸­' : 'ğŸ¯ æ‰‹åŠ¨é€‰æ‹©');
            updatePublishLocationDisplay();
        }

        // ==================== WebSocket è¿æ¥ ====================
        function connectWebSocket() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                console.log("âœ… WebSocket å·²è¿æ¥");
                return;
            }

            console.log("ğŸ”Œ è¿æ¥æœåŠ¡å™¨:", WS_URL);
            showNetworkStatus("æ­£åœ¨è¿æ¥æœåŠ¡å™¨...", 0);
            
            try {
                socket = new WebSocket(WS_URL);
            } catch (error) {
                console.error("âŒ åˆ›å»ºWebSocketå¤±è´¥:", error);
                updateConnectionStatus("âŒ è¿æ¥å¤±è´¥");
                showNetworkStatus("è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ", 3000);
                return;
            }

            socket.onopen = () => {
                console.log("âœ… WebSocket è¿æ¥æˆåŠŸ");
                updateConnectionStatus("âœ… å·²è¿æ¥");
                showNetworkStatus("å·²è¿æ¥åˆ°æœåŠ¡å™¨", 2000);
                
                if (currentUser) {
                    sendLogin();
                    // å‘é€å½“å‰ä½ç½®
                    sendPositionToServer();
                }
            };

            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleServerMessage(data);
                } catch (error) {
                    console.error("âŒ æ¶ˆæ¯è§£æå¤±è´¥:", error);
                }
            };

            socket.onclose = () => {
                console.log("ğŸ“¡ è¿æ¥å·²å…³é—­");
                updateConnectionStatus("âŒ è¿æ¥æ–­å¼€");
                showNetworkStatus("ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥", 2000);
                
                // 3ç§’åé‡è¿
                setTimeout(() => {
                    if (currentUser) {
                        connectWebSocket();
                    }
                }, 3000);
            };

            socket.onerror = (error) => {
                console.error("âŒ WebSocketé”™è¯¯:", error);
                updateConnectionStatus("âŒ è¿æ¥é”™è¯¯");
                showNetworkStatus("è¿æ¥é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•", 2000);
            };
        }

        function updateConnectionStatus(status) {
            const element = document.getElementById('connectionStatus');
            if (element) element.textContent = status;
        }

        function sendLogin() {
            if (!socket || socket.readyState !== WebSocket.OPEN || !currentUser) return;

            socket.send(JSON.stringify({
                type: "login",
                userId: currentUser.id,
                nickname: currentUser.nickname,
                avatar: currentUser.avatar,
                lat: myPosition.lat,
                lng: myPosition.lng
            }));
            
            console.log("ğŸ“¤ å‘é€ç™»å½•ä¿¡æ¯:", currentUser.nickname);
        }
        
        function sendPositionToServer() {
            if (!socket || socket.readyState !== WebSocket.OPEN || !currentUser) return;
            
            socket.send(JSON.stringify({
                type: "position",
                lat: myPosition.lat,
                lng: myPosition.lng,
                userId: currentUser.id,
                nickname: currentUser.nickname
            }));
            
            console.log("ğŸ“ å‘é€ä½ç½®ä¿¡æ¯:", myPosition);
        }

        function requestNearbyBubbles() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                console.error("âŒ WebSocket æœªè¿æ¥");
                return;
            }
            
            if (!myPosition) {
                console.error("âŒ æ— ä½ç½®ä¿¡æ¯");
                return;
            }
            
            // è¯·æ±‚é™„è¿‘æ°”æ³¡
            socket.send(JSON.stringify({
                type: "getNearbyBubbles"
            }));
            
            console.log("ğŸ“¡ è¯·æ±‚é™„è¿‘æ°”æ³¡");
        }

        // ==================== æ¶ˆæ¯å¤„ç† ====================
        function handleServerMessage(data) {
            console.log("ğŸ“¨ æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯:", data.type, data);

            switch (data.type) {
                case "loginSuccess":
                    handleLoginSuccess(data.user);
                    break;
                    
                case "onlineCount":
                    updateOnlineCount(data.count);
                    break;
                    
                case "newBubble":
                    console.log("ğŸˆ æ”¶åˆ°æ–°æ°”æ³¡å¹¿æ’­:", data.bubble);
                    addBubble(data.bubble);
                    break;
                    
                case "nearbyBubbles":
                    console.log("ğŸ“¦ æ”¶åˆ°é™„è¿‘æ°”æ³¡:", data.bubbles.length);
                    data.bubbles.forEach(bubble => addBubble(bubble));
                    break;
                    
                case "publicChat":
                    console.log("ğŸ’¬ æ”¶åˆ°èŠå¤©æ¶ˆæ¯:", data.from, data.msg);
                    // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå·±çš„æ¶ˆæ¯ï¼ˆé¿å…å›å£°ï¼‰
                    const isMyMessage = currentUser && 
                        (data.fromId === currentUser.id || data.from === currentUser.nickname);
                    
                    if (!isMyMessage) {
                        // åªæœ‰å…¶ä»–äººçš„æ¶ˆæ¯æ‰æ˜¾ç¤ºï¼Œè‡ªå·±çš„æ¶ˆæ¯å·²ç»åœ¨sendChatMessageä¸­æ˜¾ç¤ºäº†
                        addChatMessage({
                            from: data.from,
                            avatar: data.avatar,
                            text: data.msg,
                            time: data.time,
                            isMyMessage: false
                        });
                    }
                    break;
                    
                case "userPosition":
                    // æ›´æ–°å…¶ä»–ç”¨æˆ·çš„ä½ç½®
                    updateOtherUserPosition(data);
                    break;
                    
                default:
                    console.log("âš ï¸ æœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹:", data.type);
            }
        }

        function handleLoginSuccess(user) {
            console.log("âœ… ç™»å½•æˆåŠŸ:", user);
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            currentUser.id = user.id;
            
            // æ›´æ–°UIæ˜¾ç¤º
            document.getElementById('userNickname').textContent = currentUser.nickname;
            document.getElementById('userId').textContent = `ID: ${user.id}`;
            
            // æ›´æ–°æˆ‘çš„ä½ç½®æ ‡è®°
            updateMyMarker();
            
            // è¯·æ±‚é™„è¿‘æ°”æ³¡
            setTimeout(() => {
                requestNearbyBubbles();
            }, 500);
        }

        function updateOnlineCount(count) {
            console.log("ğŸ‘¥ åœ¨çº¿äººæ•°:", count);
            updateOnlineUsersList(count);
        }

        function updateOnlineUsersList(count) {
            const container = document.getElementById('onlineUsersList');
            if (!container) return;
            
            container.innerHTML = `
                <div class="user-item">
                    <span style="color: #5483B3">ğŸ‘¤</span>
                    <span>å½“å‰åœ¨çº¿: ${count} äºº</span>
                </div>
            `;
        }

        function updateOtherUserPosition(data) {
            // å¦‚æœæ˜¯è‡ªå·±ï¼Œè·³è¿‡
            if (currentUser && data.userId === currentUser.id) {
                return;
            }
            
            // æ›´æ–°æˆ–åˆ›å»ºç”¨æˆ·æ ‡è®°
            let marker = userMarkers[data.userId];
            
            if (!marker) {
                // åˆ›å»ºæ–°æ ‡è®°
                const icon = new qq.maps.MarkerImage(
                    'data:image/svg+xml;utf8,' + encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
                            <circle cx="20" cy="20" r="18" fill="#FFAA00" stroke="white" stroke-width="2"/>
                            <text x="20" y="28" text-anchor="middle" fill="white" font-size="18" font-family="Arial">ğŸ‘¤</text>
                        </svg>
                    `),
                    new qq.maps.Size(40, 40),
                    new qq.maps.Point(0, 0),
                    new qq.maps.Point(20, 20)
                );
                
                marker = new qq.maps.Marker({
                    map: map,
                    position: new qq.maps.LatLng(data.lat, data.lng),
                    title: `${data.nickname} (${data.userId})`,
                    icon: icon
                });
                
                userMarkers[data.userId] = marker;
            } else {
                // æ›´æ–°ä½ç½®
                marker.setPosition(new qq.maps.LatLng(data.lat, data.lng));
            }
            
            console.log(`ğŸ“ æ›´æ–°ç”¨æˆ·ä½ç½®: ${data.nickname} (${data.lat.toFixed(4)}, ${data.lng.toFixed(4)})`);
        }

        // ==================== æ°”æ³¡åŠŸèƒ½ ====================
        function selectBubbleType(type) {
            selectedBubbleType = type;
            
            // æ›´æ–°UI
            document.querySelectorAll('.bubble-type-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('selected');
            
            console.log("âœ… é€‰æ‹©æ°”æ³¡ç±»å‹:", type);
        }

        function publishBubble() {
            const title = document.getElementById('bubbleTitle').value.trim();
            const content = document.getElementById('bubbleContent').value.trim();
            
            if (!title) {
                showNetworkStatus("è¯·è¾“å…¥æ°”æ³¡æ ‡é¢˜", 2000);
                return;
            }
            
            if (!currentUser) {
                showNetworkStatus("è¯·å…ˆç™»å½•", 2000);
                return;
            }
            
            // ä½¿ç”¨å½“å‰é€‰æ‹©çš„ä½ç½®
            const publishPosition = myPosition;
            
            // âœ… ä½¿ç”¨æ­£ç¡®çš„æ¶ˆæ¯æ ¼å¼ï¼špublishBubble
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: "publishBubble",
                    bubbleType: selectedBubbleType,
                    title: title,
                    content: content,
                    lat: publishPosition.lat,
                    lng: publishPosition.lng,
                    duration: 3600,
                    activityTags: []
                }));
                
                console.log("ğŸ“¤ å‘é€æ°”æ³¡(publishBubble):", {title, type: selectedBubbleType});
                showNetworkStatus("æ°”æ³¡å‘å¸ƒæˆåŠŸï¼", 2000);
            }
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('bubbleTitle').value = '';
            document.getElementById('bubbleContent').value = '';
        }

        function addBubble(bubble) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (bubbles.find(b => b.id === bubble.id)) {
                console.log("âš ï¸ æ°”æ³¡å·²å­˜åœ¨ï¼Œè·³è¿‡:", bubble.id);
                return;
            }
            
            // æ·»åŠ åˆ°åˆ—è¡¨
            bubbles.push(bubble);
            
            // æ›´æ–°æ°”æ³¡åˆ—è¡¨UI
            updateBubblesList();
            
            // åœ¨åœ°å›¾ä¸Šæ˜¾ç¤º
            addBubbleToMap(bubble);
            
            console.log("âœ… æ·»åŠ æ°”æ³¡:", bubble.title);
            showNetworkStatus(`æ”¶åˆ°æ–°æ°”æ³¡: ${bubble.title}`, 2000);
        }

        function updateBubblesList() {
            const container = document.getElementById('bubblesList');
            if (!container) return;
            
            container.innerHTML = bubbles.map(bubble => `
                <div class="bubble-item" onclick="focusBubbleOnMap('${bubble.id}')">
                    <div class="bubble-header">
                        <span style="font-weight: 600; color: #052659;">${bubble.title}</span>
                        <span class="bubble-type bubble-${bubble.type}">${getBubbleTypeName(bubble.type)}</span>
                    </div>
                    <div style="font-size: 13px; color: #6c757d; margin: 5px 0">ä½œè€…: ${bubble.author}</div>
                    <div style="font-size: 11px; color: #adb5bd;">${formatTime(bubble.time)}</div>
                </div>
            `).join('');
        }

        function getBubbleTypeName(type) {
            const names = {
                recommend: 'æ¨è',
                help: 'æ±‚åŠ©',
                team: 'ç»„é˜Ÿ',
                warning: 'é¿é›·',
                news: 'è§é—»'
            };
            return names[type] || type;
        }

        function addBubbleToMap(bubble) {
            if (!map) return;
            
            const icon = getBubbleIcon(bubble.type);
            
            const marker = new qq.maps.Marker({
                map: map,
                position: new qq.maps.LatLng(bubble.lat, bubble.lng),
                title: bubble.title,
                icon: icon
            });
            
            // ç‚¹å‡»æ ‡è®°æ˜¾ç¤ºæ°”æ³¡ä¿¡æ¯
            qq.maps.event.addListener(marker, 'click', () => {
                showBubbleInfo(bubble);
            });
            
            // ä¿å­˜æ ‡è®°å¼•ç”¨
            bubble.marker = marker;
        }

        function getBubbleIcon(type) {
            const emojis = {
                recommend: 'ğŸ‘',
                help: 'ğŸ†˜',
                team: 'ğŸ‘¥',
                warning: 'âš ï¸',
                news: 'ğŸ“°'
            };
            
            const emoji = emojis[type] || 'ğŸˆ';
            const color = getBubbleColor(type);
            
            // åˆ›å»ºSVGå›¾æ ‡
            const svg = `
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">
                    <circle cx="24" cy="24" r="22" fill="${color}" stroke="white" stroke-width="3"/>
                    <text x="24" y="32" text-anchor="middle" fill="white" font-size="24" font-family="Arial">${emoji}</text>
                </svg>
            `;
            
            return new qq.maps.MarkerImage(
                'data:image/svg+xml;utf8,' + encodeURIComponent(svg),
                new qq.maps.Size(48, 48),
                new qq.maps.Point(0, 0),
                new qq.maps.Point(24, 24)
            );
        }

        function getBubbleColor(type) {
            const colors = {
                recommend: '#FF4444',
                help: '#FFD700',
                team: '#4169E1',
                warning: '#9932CC',
                news: '#FF69B4'
            };
            return colors[type] || '#5483B3';
        }

        function focusBubbleOnMap(bubbleId) {
            const bubble = bubbles.find(b => b.id === bubbleId);
            if (bubble && map) {
                map.panTo(new qq.maps.LatLng(bubble.lat, bubble.lng));
                map.setZoom(17);
                
                showBubbleInfo(bubble);
            }
        }

        function showBubbleInfo(bubble) {
            const info = `
ğŸˆ æ°”æ³¡è¯¦æƒ…ï¼š
æ ‡é¢˜ï¼š${bubble.title}
ç±»å‹ï¼š${getBubbleTypeName(bubble.type)}
ä½œè€…ï¼š${bubble.author}
å†…å®¹ï¼š${bubble.content || "æ— å†…å®¹"}
æ—¶é—´ï¼š${formatTime(bubble.time)}
ä½ç½®ï¼š${bubble.lat.toFixed(4)}, ${bubble.lng.toFixed(4)}
            `;
            
            // ä½¿ç”¨æ›´ç¾è§‚çš„æç¤ºæ–¹å¼
            showNetworkStatus(info, 3000);
        }

        function clearAllBubbles() {
            // ä»åœ°å›¾ä¸Šç§»é™¤æ‰€æœ‰æ°”æ³¡æ ‡è®°
            bubbles.forEach(bubble => {
                if (bubble.marker) {
                    bubble.marker.setMap(null);
                }
            });
            
            // æ¸…ç©ºåˆ—è¡¨
            bubbles = [];
            updateBubblesList();
            
            console.log("âœ… å·²æ¸…é™¤æ‰€æœ‰æ°”æ³¡");
            showNetworkStatus("å·²æ¸…é™¤æ‰€æœ‰æ°”æ³¡", 2000);
        }

        // ==================== å…¬å±èŠå¤©åŠŸèƒ½ ====================
        function toggleChatPanel() {
            chatPanelVisible = !chatPanelVisible;
            const panel = document.getElementById('chatPanel');
            const toggleBtn = document.getElementById('chatToggleBtn');
            
            if (chatPanelVisible) {
                panel.style.display = 'flex';
                toggleBtn.style.display = 'none';
                unreadCount = 0;
                updateChatBadge();
                document.getElementById('chatInput').focus();
            } else {
                panel.style.display = 'none';
                toggleBtn.style.display = 'flex';
            }
        }

        function handleChatInputKey(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            if (!currentUser) {
                showNetworkStatus("è¯·å…ˆç™»å½•", 2000);
                return;
            }
            
            // ç”Ÿæˆæ¶ˆæ¯IDç”¨äºé˜²æ­¢å›å£°
            const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sentMessageIds.add(messageId);
            
            // ç«‹å³åœ¨æœ¬åœ°æ˜¾ç¤ºè‡ªå·±çš„æ¶ˆæ¯
            addChatMessage({
                id: messageId,
                from: currentUser.nickname,
                avatar: currentUser.avatar,
                text: text,
                time: Date.now(),
                isMyMessage: true
            });
            
            // âœ… ä½¿ç”¨æ­£ç¡®çš„æ¶ˆæ¯æ ¼å¼ï¼špublicChat
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: "publicChat",
                    msg: text,
                    messageId: messageId // æ·»åŠ æ¶ˆæ¯IDç”¨äºæœåŠ¡å™¨è¯†åˆ«
                }));
                
                console.log("ğŸ“¤ å‘é€èŠå¤©æ¶ˆæ¯:", text);
            }
            
            input.value = '';
            input.focus();
        }

        function addChatMessage(message) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡å¤ï¼‰
            if (message.id && sentMessageIds.has(message.id)) {
                console.log("âš ï¸ æ¶ˆæ¯å·²å­˜åœ¨ï¼Œè·³è¿‡:", message.id);
                return;
            }
            
            // æ·»åŠ åˆ°åˆ—è¡¨
            chatMessages.push(message);
            
            // ä¿æŒæœ€å¤š100æ¡æ¶ˆæ¯
            if (chatMessages.length > 100) {
                chatMessages = chatMessages.slice(-100);
            }
            
            // æ›´æ–°UI
            updateChatMessages();
            
            // æœªè¯»æ¶ˆæ¯æç¤º
            if (!chatPanelVisible && !message.isMyMessage) {
                unreadCount++;
                updateChatBadge();
            }
            
            console.log("ğŸ’¬ æ·»åŠ èŠå¤©æ¶ˆæ¯:", message.from, message.text);
        }

        function updateChatMessages() {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            
            container.innerHTML = chatMessages.map(msg => {
                const messageClass = msg.isMyMessage ? 'chat-message my-message' : 'chat-message';
                const senderName = msg.isMyMessage ? 'æˆ‘' : msg.from;
                const avatar = msg.isMyMessage ? 'ğŸ‘¤' : (msg.avatar || 'ğŸ‘¤');
                
                return `
                    <div class="${messageClass}">
                        <div class="sender">${avatar} ${senderName}</div>
                        <div style="color: #052659; font-size: 13px;">${escapeHtml(msg.text)}</div>
                        <div class="time">${formatTime(msg.time, true)}</div>
                    </div>
                `;
            }).join('');
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            container.scrollTop = container.scrollHeight;
        }

        function updateChatBadge() {
            const badge = document.getElementById('chatBadge');
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // ==================== è¾…åŠ©å‡½æ•° ====================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(timestamp, showSeconds = false) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            // å¦‚æœæ˜¯ä»Šå¤©
            if (diff < 24 * 60 * 60 * 1000) {
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const seconds = showSeconds ? ':' + date.getSeconds().toString().padStart(2, '0') : '';
                return `${hours}:${minutes}${seconds}`;
            }
            
            // å¦‚æœæ˜¯ä»Šå¹´
            if (date.getFullYear() === now.getFullYear()) {
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${month}-${day}`;
            }
            
            return date.toLocaleDateString();
        }

        function showNetworkStatus(message, duration = 3000) {
            const status = document.getElementById('networkStatus');
            status.textContent = message;
            status.classList.add('show');
            
            if (duration > 0) {
                setTimeout(() => {
                    status.classList.remove('show');
                }, duration);
            }
        }

        // ==================== æµ‹è¯•å‡½æ•° ====================
        function loginTestUser() {
            currentUser = {
                id: "user_" + Math.floor(Math.random() * 10000),
                nickname: "æµ‹è¯•ç”¨æˆ·" + Math.floor(Math.random() * 100),
                avatar: "ğŸ‘¤"
            };
            
            console.log("ğŸ‘¤ ç™»å½•æµ‹è¯•ç”¨æˆ·:", currentUser);
            
            // è¿æ¥WebSocket
            connectWebSocket();
            
            // æ›´æ–°UI
            document.getElementById('userNickname').textContent = currentUser.nickname;
            document.getElementById('userId').textContent = `ID: ${currentUser.id}`;
            
            showNetworkStatus(`å·²ç™»å½•ä¸º ${currentUser.nickname}`, 2000);
        }
    </script>
</body>
</html>
